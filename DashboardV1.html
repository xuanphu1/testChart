<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sensor Chart</title>

    <!-- Import Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    <style>
        .highcharts-figure {
            min-width: 320px;
            max-width: 800px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }
    </style>
</head>
<body>

    <figure class="highcharts-figure">
        <div id="container"></div>
    </figure>
<input type="checkbox" id="Temperature">
<input type="checkbox" id="Water level">
<input type="checkbox" id="TDS Value">
<input type="checkbox" id="PH Value">
<input type="checkbox" id="Conductivity Value">

<script>
    // Era Widget initialization
    const eraWidget = new EraWidget();
    let config = null;
    let TemperatureValue = 1; // Giá trị nhiệt độ
    let WaterLevelValue = 1;  // Giá trị mực nước
    let TDSValue = 1;  // Giá trị mực nước
    let PHValue = 1;  // Giá trị mực nước
    let ConductivityValue = 1;  // Giá trị mực nước


    eraWidget.onConfiguration((configuration) => {
        configTemp = configuration.realtime_configs.find(cfg => cfg.name === "Temperature");
        configWater = configuration.realtime_configs.find(cfg => cfg.name === "Water Level");
        configTDS = configuration.realtime_configs.find(cfg => cfg.name === "TDS Value");
        configPH = configuration.realtime_configs.find(cfg => cfg.name === "PH Value");
        configConductivity = configuration.realtime_configs.find(cfg => cfg.name === "Conductivity Value");
    });

    eraWidget.onValues((values) => {
        const input_temperature = document.getElementById('Temperature');
        const input_waterLevel = document.getElementById('Water level');
        const input_tds = document.getElementById('TDS Value');
        const input_ph = document.getElementById('PH Value');
        const input_conductivity = document.getElementById('Conductivity Value');

        // Kiểm tra nếu config hợp lệ mới gán giá trị
        if (config && values[config.id]) {
            TemperatureValue = values[configTemp.id].value; 
            WaterLevelValue = values[configWater.id].value;
            TDSValue = values[configTDS.id].value;
            PHValue = values[configPH.id].value;
            ConductivityValue = values[configConductivity.id].value; 
            
            // Đặt trạng thái của checkbox
            input_temperature.checked = TemperatureValue > 0; 
            input_waterLevel.checked = WaterLevelValue > 0;
            input_tds.checked = TDSValue > 0;
            input_ph.checked = PHValue > 0;
            input_conductivity.checked = ConductivityValue > 0;
        }
    });

    eraWidget.ready();
</script>

    <script>
        
        // Khởi tạo dữ liệu ban đầu
        function generateInitialData() {
            const data = [];
            const time = new Date().getTime();
            for (let i = -19; i <= 0; i += 1) {
                data.push({
                    x: time + i * 1000,
                    y: Math.random()
                });
            }
            return data;
        }

        // Hàm tạo hiệu ứng di chuyển giống Conductivity
        function addConductivityEffect(series, point) {
            if (!series.pulse) {
                series.pulse = series.chart.renderer.circle()
                    .attr({
                        r: 5,
                        opacity: 0
                    })
                    .add(series.markerGroup);
            }

            setTimeout(() => {
                series.pulse
                    .attr({
                        x: series.xAxis.toPixels(point.x, true),
                        y: series.yAxis.toPixels(point.y, true),
                        r: 5,
                        opacity: 1,
                        fill: series.color
                    })
                    .animate({
                        r: 20,
                        opacity: 0
                    }, {
                        duration: 1000
                    });
            }, 1);
        }

        // Cập nhật dữ liệu theo thời gian thực
        function onChartLoad() {
            const chart = this,
                series = chart.series;

            setInterval(function () {
                const x = (new Date()).getTime();

                // Dữ liệu ngẫu nhiên cho 5 giá trị
                let newDataPoints = [
                    { seriesIndex: 0, y: TemperatureValue },  // Temperature (°C)
                    { seriesIndex: 1, y: WaterLevelValue }, // Water Level (%)
                    { seriesIndex: 2, y: Math.random() * 500 }, // TDS Value (ppm)
                    { seriesIndex: 3, y: Math.random() * 14 },  // PH Value
                    { seriesIndex: 4, y: Math.random() * 2000 } // Conductivity (μS/cm)
                ];

                newDataPoints.forEach((dataPoint) => {
                    let seriesTarget = series[dataPoint.seriesIndex];
                    seriesTarget.addPoint([x, dataPoint.y], true, true);
                    addConductivityEffect(seriesTarget, { x, y: dataPoint.y });
                });

            }, 1000);
        }

        // Khởi tạo biểu đồ
        Highcharts.chart('container', {
            chart: {
                type: 'spline',
                events: {
                    load: onChartLoad
                }
            },

            time: {
                useUTC: false
            },

            title: {
                text: 'Live Sensor Data'
            },

            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                maxPadding: 0.1
            },

            yAxis: {
                title: {
                    text: 'Value'
                },
                plotLines: [
                    {
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }
                ]
            },

            tooltip: {
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}'
            },

            legend: {
                enabled: true
            },

            exporting: {
                enabled: false
            },

            series: [
                {
                    name: 'Temperature (°C)',
                    lineWidth: 2,
                    color: 'red',
                    data: generateInitialData()
                },
                {
                    name: 'Water Level (%)',
                    lineWidth: 2,
                    color: 'blue',
                    data: generateInitialData()
                },
                {
                    name: 'TDS Value (ppm)',
                    lineWidth: 2,
                    color: 'green',
                    data: generateInitialData()
                },
                {
                    name: 'PH Value',
                    lineWidth: 2,
                    color: 'yellow',
                    data: generateInitialData()
                },
                {
                    name: 'Conductivity (μS/cm)',
                    lineWidth: 2,
                    color: 'purple',
                    data: generateInitialData()
                }
            ]
        });
    </script>

</body>
</html>
